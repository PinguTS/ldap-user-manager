# LDAP Directory Structure for ldap-user-manager

---

## Quick Start: Copy & Paste Samples

### Example Organization LDIF
```ldif
dn: o=OrgA,ou=organizations,dc=example,dc=com
objectClass: top
objectClass: organization
objectClass: labeledURIObject
objectClass: extensibleObject
o: OrgA
postalAddress: 123 Main St$12345$City$Country
telephoneNumber: +1 555 1234
labeledURI: http://www.orga.com
mail: info@orga.com
# Note: entryUUID is automatically generated by OpenLDAP
```

### Example User LDIF (with passcode)
```ldif
dn: uid=jane.doe,ou=people,o=OrgA,ou=organizations,dc=example,dc=com
objectClass: inetOrgPerson
objectClass: top
uid: jane.doe
mail: jane.doe@orga.com
cn: Jane Doe
givenname: Jane
sn: Doe
userPassword: {SSHA}dummyhash
# Note: entryUUID is automatically generated by OpenLDAP
# Note: Passcodes are stored in userPassword attribute alongside passwords
```

### Example Organization Admin Group LDIF
```ldif
dn: cn=orgManagers,o=OrgA,ou=organizations,dc=example,dc=com
objectClass: groupOfNames
cn: orgManagers
member: uid=jane.doe,ou=people,o=OrgA,ou=organizations,dc=example,dc=com
```

### Example Global Admin Group LDIF
```ldif
dn: cn=administrators,ou=roles,dc=example,dc=com
objectClass: groupOfNames
cn: administrators
member: uid=admin@example.com,ou=people,dc=example,dc=com
```

### Example Global Maintainer Group LDIF
```ldif
dn: cn=maintainers,ou=roles,dc=example,dc=com
objectClass: groupOfNames
cn: maintainers
member: uid=maintainer@example.com,ou=people,dc=example,dc=com
```

### Example OpenLDAP ACLs
```
# 1. Administrators: Full access everywhere
access to *
  by group.exact="cn=administrators,ou=roles,dc=example,dc=com" manage

# 2. Maintainers: Full access except admin users/groups
access to dn.regex="^uid=.+,ou=people,o=.*,ou=organizations,dc=example,dc=com$"
  by group.exact="cn=maintainers,ou=roles,dc=example,dc=com" write

# Prevent maintainers from modifying admin users
access to dn.regex="^uid=admin.*,ou=people,o=.*,ou=organizations,dc=example,dc=com$"
  by group.exact="cn=maintainers,ou=roles,dc=example,dc=com" none

# 3. Org Managers: Manage users in their own org
access to dn.regex="^uid=.+,ou=people,o=([^,]+),ou=organizations,dc=example,dc=com$"
  by group.exact="cn=orgManagers,o=$1,ou=organizations,dc=example,dc=com" write

# 4. Users: Self-management (e.g., change their own password)
access to dn.regex="^uid=([^,]+),ou=people,o=.*,ou=organizations,dc=example,dc=com$"
  by self write

# 5. Read access for all authenticated users
access to *
  by users read
  by anonymous auth
```

---

## 1. DIT Structure

```
dc=example,dc=com
|
|-- ou=people
|    |-- uid=admin@example.com          # System administrator (email customizable)
|    |   # entryUUID: 550e8400-e29b-41d4-a716-446655440000
|    |-- uid=maintainer@example.com     # System maintainer (email customizable)
|        # entryUUID: 550e8400-e29b-41d4-a716-446655440001
|
|-- ou=organizations
|    |-- o=OrgA                         # entryUUID: 550e8400-e29b-41d4-a716-446655440002
|    |    |-- ou=people                 # Organization users
|    |    |    |-- uid=user1
|    |    |    |-- uid=user2
|    |    |-- cn=orgManagers            # Organization administrators (direct group)
|    |-- o=OrgB
|         |-- ou=people                 # Organization users
|         |    |-- uid=user3
|         |-- cn=orgManagers            # Organization administrators (direct group)
|
|-- ou=roles                            # Global system roles only
|    |-- cn=administrators
|    |-- cn=maintainers
```

- **System Users**: Stored under `ou=people,dc=example,dc=com` (administrators, maintainers)
- **Email Customization**: Admin and maintainer email addresses can be customized during setup
- **Organizations**: Each as an `organization` entry under `ou=organizations`
- **Organization Users**: Under `ou=people` within their org (consistent naming)
- **Organization Administrators**: Direct group entries under each organization (`cn=orgManagers`)
- **Global Roles**: Under `ou=roles,dc=example,dc=com` (system-wide roles only)

---

## 2. Object Classes and Attributes

### Organizations
- **Primary Object Classes**: `organization`, `top`
- **Extended Object Classes**: `labeledURIObject`, `extensibleObject`
- **Required Attributes**: `o` (organization name)
- **Supported Additional Attributes**:
  - `postalAddress`: Full address in format "Street$ZIP$City$Country"
  - `telephoneNumber`: Phone number
  - `labeledURI`: Website URL
  - `mail`: Email address
  - `description`: Organization description/status
  - `businessCategory`: Business category
- **Operational Attributes**:
  - `entryUUID`: Unique identifier for URL parameters and API calls

### Users
- **Object Classes**: `inetOrgPerson`, `top`
- **Required Attributes**: `uid`, `cn`, `sn`, `mail`
- **Password Attributes**: `userPassword`, `loginPasscode`
- **Operational Attributes**:
  - `entryUUID`: Unique identifier for URL parameters and API calls

### Groups
- **Object Classes**: `groupOfNames`
- **Required Attributes**: `cn`, `member`

---

## 3. UUID-Based Identification

### Why Use entryUUID?
The application uses OpenLDAP's `entryUUID` operational attribute for secure identification:

- **Security**: Prevents LDAP injection and data manipulation attacks
- **Reliability**: Unique, immutable identifiers that don't change with names
- **URL Safety**: UUIDs are URL-safe and don't require special encoding
- **Performance**: Efficient lookups using indexed UUID attributes

### URL Parameter Format
Instead of using names or DNs in URLs, the application uses UUIDs:

```
# Before (insecure):
/organizations.php?org=Org%20Name%20with%20Spaces
/show_organization.php?org=OrgName

# After (secure):
/organizations.php?uuid=550e8400-e29b-41d4-a716-446655440000
/show_organization.php?uuid=550e8400-e29b-41d4-a716-446655440000
```

### Implementation Benefits
- **No URL Encoding Issues**: UUIDs are always URL-safe
- **No Special Character Problems**: Works with any organization/user names
- **Audit Trail**: Stable references for logging and tracking
- **API Design**: Better for RESTful API endpoints
- **Caching**: Reliable cache keys

### Environment Variables
The UUID-based identification can be configured using environment variables:

```bash
# Enable/disable UUID-based identification (default: true)
LDAP_USE_UUID_IDENTIFICATION=true

# Custom UUID attribute name (default: entryUUID)
LDAP_UUID_ATTRIBUTE=entryUUID
```

### Fallback Support
The system maintains backward compatibility:
- **UUID Mode**: Uses `entryUUID` for all operations when available
- **Legacy Mode**: Falls back to name-based identification when UUIDs are not available
- **Hybrid Mode**: Can use both approaches simultaneously during transition

---

## 4. Example LDIF Entries

### Organization (with extended attributes)
```ldif
dn: o=OrgA,ou=organizations,dc=example,dc=com
objectClass: top
objectClass: organization
objectClass: labeledURIObject
objectClass: extensibleObject
o: OrgA
postalAddress: 123 Main St$12345$City$Country
telephoneNumber: +1 555 1234
labeledURI: http://www.orga.com
mail: info@orga.com
description: Active
businessCategory: Technology
# Operational attributes (automatically generated)
entryUUID: 550e8400-e29b-41d4-a716-446655440000
```

### User
```ldif
dn: uid=jane.doe,ou=people,o=OrgA,ou=organizations,dc=example,dc=com
objectClass: inetOrgPerson
objectClass: top
uid: jane.doe
mail: jane.doe@orga.com
cn: Jane Doe
sn: Doe
userPassword: {SSHA}...
# Operational attributes (automatically generated)
entryUUID: 6ba7b810-9dad-11d1-80b4-00c04fd430c8
```

### Org Manager Group
```ldif
dn: cn=orgManagers,o=OrgA,ou=organizations,dc=example,dc=com
objectClass: groupOfNames
cn: orgManagers
member: uid=jane.doe,ou=people,o=OrgA,ou=organizations,dc=example,dc=com
```

### Global Admin Group
```ldif
dn: cn=administrators,ou=roles,dc=example,dc=com
objectClass: groupOfNames
cn: administrators
member: uid=admin@example.com,ou=people,dc=example,dc=com
```

---

## 4. Organization Attribute Details

### Address Format
The `postalAddress` attribute consolidates all address information into a single field:
- **Format**: `Street$ZIP$City$Country`
- **Example**: `123 Main St$12345$New York$USA`
- **Benefits**: 
  - Single attribute for all address data
  - Consistent with LDAP standards
  - Easy to parse and display

### Extended Object Classes
To support additional attributes beyond the basic `organization` object class:
- **`labeledURIObject`**: Enables `labeledURI` attribute for website URLs
- **`extensibleObject`**: Allows custom attributes like `mail`, `description`, `businessCategory`

### Schema Requirements
- **OpenLDAP**: No schema modifications required
- **Standard Compliance**: Uses only standard LDAP object classes
- **Extensibility**: Additional attributes can be added without schema changes

---

## 5. User Field Configuration

### 5.1 System Users (ou=people)
System users have simplified attributes for administrators and maintainers:

**Required Fields:**
- `uid`: User identifier (auto-generated from email)
- `givenname`: First name
- `sn`: Last name  
- `mail`: Email address

**Auto-generated Fields:**
- `cn`: Common name (constructed from `givenname` + `sn`)

**Optional Fields:**
- `telephoneNumber`: Phone number
- `labeledURI`: Website URL

**No Address Fields:** System users don't need location information.

### 5.2 Organization Users (ou=people,o=OrgName)
Organization users have additional organizational context:

**Required Fields:**
- `uid`: User identifier (auto-generated from email)
- `givenname`: First name
- `sn`: Last name
- `mail`: Email address
- `organization`: Organization name
- `description`: User role within organization

**Auto-generated Fields:**
- `cn`: Common name (constructed from `givenname` + `sn`)

**Optional Fields:**
- `telephoneNumber`: Phone number
- `labeledURI`: Website URL

**No Address Fields:** Address information is stored at organization level.

### 5.3 Common User Attributes
All users include:
- `objectClass`: `inetOrgPerson`, `top`
- `userPassword`: Stores both regular passwords and app-managed passcodes
- `entryUUID`: OpenLDAP operational attribute for secure identification

---

## 6. Notes
- Use the same structure for each organization.
- All user containers use the consistent `ou=people` naming convention.
- Add users to the appropriate group for role-based access.
- Extended attributes are automatically supported when using the extended object classes.
- The `postalAddress` format follows LDAP standards and is searchable.

---

## 7. Example OpenLDAP ACLs and Server Configuration

To enforce role-based access control at the LDAP server level, add the following example ACLs to your OpenLDAP configuration (e.g., `slapd.conf` or dynamic config via `ldapmodify`). Adjust DNs as needed for your deployment.

### Example ACLs

```
# 1. Administrators: Full access everywhere
access to *
  by group.exact="cn=administrators,ou=roles,dc=example,dc=com" manage

# 2. Maintainers: Full access except admin users/groups
access to dn.regex="^uid=.+,ou=people,o=.*,ou=organizations,dc=example,dc=com$"
  by group.exact="cn=maintainers,ou=roles,dc=example,dc=com" write

# Prevent maintainers from modifying admin users
access to dn.regex="^uid=admin.*,ou=people,o=.*,ou=organizations,dc=example,dc=com$"
  by group.exact="cn=maintainers,ou=roles,dc=example,dc=com" none

# 3. Org Managers: Manage users in their own org
access to dn.regex="^uid=.+,ou=people,o=([^,]+),ou=organizations,dc=example,dc=com$"
  by group.exact="cn=orgManagers,o=$1,ou=organizations,dc=example,dc=com" write

# 4. Users: Self-management (e.g., change their own password)
access to dn.regex="^uid=([^,]+),ou=people,o=.*,ou=organizations,dc=example,dc=com$"
  by self write

# 5. Read access for all authenticated users
access to *
  by users read
  by anonymous auth
```

#### **Notes:**
- Adjust the regex and group DNs to match your DIT if you change the structure.
- The `$1` in the org manager ACL refers to the org name captured in the regex.
- Place more specific ACLs above more general ones.
- The `manage` privilege gives full control; `write` allows modification but not deletion of entries.

### Required LDAP Server Configuration

- **Groups:** Ensure your `administrators`, `maintainers`, and per-org `orgManagers` groups exist and are populated with the correct user DNs.
- **Schema:** The above ACLs assume you use `groupOfNames` for groups, with the `member` attribute.
- **DIT:** The DIT structure must match the patterns in the ACLs (see above in this document).
- **Restart slapd:** After updating ACLs, restart the LDAP server or reload the configuration.
- **Test:** Use `ldapsearch` and your application to verify access for each role.

#### **Example: Add a user to a group**
To add a user to the administrators group:
```ldif
dn: cn=administrators,ou=roles,dc=example,dc=com
changetype: modify
add: member
member: uid=admin@example.com,ou=people,dc=example,dc=com
```

--- 

---

## 8. Passcode Support for User Authentication

### Passcode Attribute
- **Attribute:** `userPassword` (same attribute as passwords)
- **ObjectClass:** `inetOrgPerson` (standard LDAP schema)
- **Purpose:** Allows users to authenticate with a passcode (in addition to password).
- **Storage:** Passcodes are stored as hashes in the same `userPassword` attribute as passwords.
- **Usage:**
  - Can be set/changed by admins, org managers, or the user themselves.
  - Used for login as an alternative to password.
  - Multiple values supported in single `userPassword` attribute.

### Example LDIF (with passcode)
```ldif
dn: uid=jane.doe,ou=people,o=OrgA,ou=organizations,dc=example,dc=com
objectClass: inetOrgPerson
objectClass: top
uid: jane.doe
mail: jane.doe@orga.com
cn: Jane Doe
givenname: Jane
sn: Doe
userPassword: {SSHA}dummyhash
userPassword: {bcrypt}$2y$10$examplehash
```

### Notes
- **No Schema Extension Required**: Uses existing `userPassword` attribute for both passwords and passcodes
- **Multiple Values**: Single `userPassword` attribute can contain multiple hashed values
- **Standard Compliance**: Works with any LDAP server without custom schema modifications
- **Secure Storage**: Passcodes are hashed using the same secure methods as passwords
- **Dual Authentication**: Login form supports both password and passcode authentication 